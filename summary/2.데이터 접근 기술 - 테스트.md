# 데이터 접근 기술 - 테스트

테스트 - 데이터베이스 연동

src/test/resources/application.properties

```properties
spring.profiles.active=test
spring.datasource.url=jdbc:h2:tcp://localhost/~/testcase
spring.datasource.username=sa

logging.level.org.springframework.jdbc=debug
```

```java
@SpringBootTest
class ItemRepositoryTest {

    @Autowired
    ItemRepository itemRepository;

    @Autowired
    PlatformTransactionManager transactionManager;

    TransactionStatus status;

    @BeforeEach
    void beforeEach() {
        status = transactionManager.getTransaction(new DefaultTransactionDefinition());
    }

    @AfterEach
    void afterEach() {
        //MemoryItemRepository 의 경우 제한적으로 사용
        if (itemRepository instanceof MemoryItemRepository) {
            ((MemoryItemRepository) itemRepository).clearStore();
        }

        transactionManager.rollback(status);
    }
}
```

테스트가 끝나고 트랜잭션을 강제로 롤백해버리면 데이터가 깔끔하게 제거된다.

테스트는 여러번 실행해도 같은 결과가 나와야 하기 때문에 `@BeforeEach`, `@AfterEach`를 사용해서 적용한다.


---

## @Transactional

스프링은 테스트 데이터 초기화를 위해 트랜잭션을 적용하고 롤백하는 방식을 `@Transactional` 애노테이션 하나로 깔끔하게 해결해준다.

```java
@SpringBootTest
@Transactional
class ItemRepositoryTest {

    @Autowired
    ItemRepository itemRepository;
//
//    @Autowired
//    PlatformTransactionManager transactionManager;
//    TransactionStatus status;
//
//    @BeforeEach
//    void beforeEach() {
//        status = transactionManager.getTransaction(new DefaultTransactionDefinition());
//    }

    @AfterEach
    void afterEach() {
        //MemoryItemRepository 의 경우 제한적으로 사용
        if (itemRepository instanceof MemoryItemRepository) {
            ((MemoryItemRepository) itemRepository).clearStore();
        }

        //transactionManager.rollback(status);
    }
    ///
}
```

> 테스트 케이스의 메서드나 클래스에 `@Transactional`을 직접 붙여서 사용할 때 만 위와 같이 작용한다.
> 트랜잭션을 테스트에서 시작하기 때문에 서비스, 리포지토리에 있는 `@Transactional`도 테스트에서 시작한 트랜잭션에 참여하게 된다.

---

## 임베디드 모드 DB

테스트 케이스를 실행하기 위해 별도의 DB를 설치하고 운영하는 것은 번잡한 작업이다.

테스트를 검증할 용도로만 사용하기 때문에 테스트가 끝나면 DB의 데이터를 모두 삭제히도 된다.

---

**임베디드 모드**

H2 DB는 자바로 개발되어 있고, JVM 안에서 메모리 모드로 동작하는 특별한 기능을 제공한다.

DB를 애플리케이션에 내장해서 함께 실행하여 임베디드 모드라 한다.

애플리케이션이 종료되면 임베디드 모드로 동작하는 H2 DB도 함께 종료되고, 데이터도 모두 사라진다.

```java
@Import(JdbcTemplateV3Config.class)
@SpringBootApplication(scanBasePackages = "hello.itemservice.web")
public class ItemServiceApplication {

	public static void main(String[] args) {
		SpringApplication.run(ItemServiceApplication.class, args);
	}

	@Bean
	@Profile("local")
	public TestDataInit testDataInit(ItemRepository itemRepository) {
		return new TestDataInit(itemRepository);
	}


	@Bean
	@Profile("test")
	public DataSource dataSource() {
		log.info("메모리 데이터베이스 초기화");
		DriverManagerDataSource dataSource = new DriverManagerDataSource();
		dataSource.setDriverClassName("org.h2.Driver");
		dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");
		dataSource.setUsername("sa");
		dataSource.setPassword("");
		return dataSource;
	}
}
```

test환경에서 사용될 빈을 등록해준다.

`jdbc:h2:mem:db`: 데이터소스를 만들 때 임베디드 모드로 동작하는 H2 DB를 사용할 수 있다.

메모리 모드에서 사용되는 DB이기 때문에 테이블을 만들어 주어야 하는데, `resources/schema.sql`파일을 만들어 주어야한다.

resources/schema.sql

```sql
drop table if exists item CASCADE;
create table item
(
 id bigint generated by default as identity,
 item_name varchar(10),
 price integer,
 quantity integer,
 primary key (id)
);
```

---

## 스프링 부트와 임베디드 모드

스프링 부트는 임베디드 DB에 대한 설정도 기본으로 제공한다.

DB에 대한 별다른 설정이 없으면 임베디드 DB를 사용한다.

---

```java
@Slf4j
//@Import(MemoryConfig.class)
//@Import(JdbcTemplateV1Config.class)
//@Import(JdbcTemplateV2Config.class)
@Import(JdbcTemplateV3Config.class)
@SpringBootApplication(scanBasePackages = "hello.itemservice.web")
public class ItemServiceApplication {

	public static void main(String[] args) {
		SpringApplication.run(ItemServiceApplication.class, args);
	}

	@Bean
	@Profile("local")
	public TestDataInit testDataInit(ItemRepository itemRepository) {
		return new TestDataInit(itemRepository);
	}
    
}
```

test환경을 위해 만들어 놓은 빈 제거

```properties
spring.profiles.active=test
#spring.datasource.url=jdbc:h2:tcp://localhost/~/testcase
#spring.datasource.username=sa

logging.level.org.springframework.jdbc=debug
```

위와같이 설정하고 테스트를 실행하면 정상적으로 돌아간다.

